function katakana_halfwidth(seq, seg)
   if (seq:sub(-2) == ";;") then
      seq = seq:sub(1, -3)
      seq = seq:gsub("x", "_")
      seq = seq:gsub("q", "-")
      seq = seq:gsub("zzi", "jji")
      seq = seq:gsub("zzy([aueo])", "jj%1")
      seq = seq:gsub( "ty([aueo])", "ch%1")
      seq = seq:gsub( "zy([aueo])",  "j%1")
      seq = seq:gsub( "jy([aueo])",  "j%1")
      seq = seq:gsub( "sy([aueo])", "sh%1")
      seq = seq:gsub("([^n])n([^aiueon])", "%1nn%2")
      seq = seq:gsub("tu", "tsu")
      seq = seq:gsub("ti", "chi")
      seq = seq:gsub("zi", "ji")
      seq = seq:gsub("si", "shi")
      seq = seq:gsub("we", "whe")
      seq = seq:gsub("wi", "whi")
      ---
      seq = seq:gsub("_tsu", "ｯ")
      --- seq = seq:gsub("_ke", "ヶ")
      --- seq = seq:gsub("_ka", "ヵ")
      --- seq = seq:gsub("_wa", "ヮ")
      seq = seq:gsub("_yo", "ｮ")
      seq = seq:gsub("_yu", "ｭ")
      seq = seq:gsub("_ya", "ｬ")
      seq = seq:gsub("_o", "ｫ")
      seq = seq:gsub("_e", "ｪ")
      seq = seq:gsub("_u", "ｩ")
      seq = seq:gsub("_i", "ｨ")
      seq = seq:gsub("_a", "ｧ")
      seq = seq:gsub("rryo", "ｯﾘｮ")
      seq = seq:gsub("rryu", "ｯﾘｭ")
      seq = seq:gsub("rrya", "ｯﾘｬ")
      seq = seq:gsub("ppyo", "ｯﾋﾟｮ")
      seq = seq:gsub("ppyu", "ｯﾋﾟｭ")
      seq = seq:gsub("ppya", "ｯﾋﾟｬ")
      seq = seq:gsub("bbyo", "ｯﾋﾞｮ")
      seq = seq:gsub("bbyu", "ｯﾋﾞｭ")
      seq = seq:gsub("bbya", "ｯﾋﾞｬ")
      seq = seq:gsub("ffyo", "ｯﾌｮ")
      seq = seq:gsub("ffyu", "ｯﾌｭ")
      seq = seq:gsub("ffya", "ｯﾌｬ")
      seq = seq:gsub("ffo", "ｯﾌｫ")
      seq = seq:gsub("ffe", "ｯﾌｪ")
      seq = seq:gsub("ffi", "ｯﾌｨ")
      seq = seq:gsub("ffa", "ｯﾌｧ")
      seq = seq:gsub("hhyo", "ｯﾋｮ")
      seq = seq:gsub("hhyu", "ｯﾋｭ")
      seq = seq:gsub("hhya", "ｯﾋｬ")
      seq = seq:gsub("ddyo", "ｯﾁﾞｮ")
      seq = seq:gsub("ddyu", "ｯﾁﾞｭ")
      seq = seq:gsub("ddya", "ｯﾁﾞｬ")
      seq = seq:gsub("ddye", "ｯﾁﾞｪ")
      seq = seq:gsub("ttso", "ｯﾂｫ")
      seq = seq:gsub("ttse", "ｯﾂｪ")
      seq = seq:gsub("ttsi", "ｯﾂｨ")
      seq = seq:gsub("ttsa", "ｯﾂｧ")
      seq = seq:gsub("tcho", "ｯﾁｮ")
      seq = seq:gsub("tchu", "ｯﾁｭ")
      seq = seq:gsub("tcha", "ｯﾁｬ")
      seq = seq:gsub("tche", "ｯﾁｪ")
      seq = seq:gsub("jjo", "ｯｼﾞｮ")
      seq = seq:gsub("jju", "ｯｼﾞｭ")
      seq = seq:gsub("jja", "ｯｼﾞｬ")
      seq = seq:gsub("jje", "ｯｼﾞｪ")
      seq = seq:gsub("ssho", "ｯｼｮ")
      seq = seq:gsub("sshu", "ｯｼｭ")
      seq = seq:gsub("ssha", "ｯｼｬ")
      seq = seq:gsub("sshe", "ｯｼｪ")
      seq = seq:gsub("ggwo", "ｯｸﾞｫ")
      seq = seq:gsub("ggwe", "ｯｸﾞｪ")
      seq = seq:gsub("ggwi", "ｯｸﾞｨ")
      seq = seq:gsub("ggwa", "ｯｸﾞｧ")
      seq = seq:gsub("ggyo", "ｯｷﾞｮ")
      seq = seq:gsub("ggyu", "ｯｷﾞｭ")
      seq = seq:gsub("ggya", "ｯｷﾞｬ")
      seq = seq:gsub("kkwo", "ｯｸｫ")
      seq = seq:gsub("kkwe", "ｯｸｪ")
      seq = seq:gsub("kkwi", "ｯｸｨ")
      seq = seq:gsub("kkwa", "ｯｸｧ")
      seq = seq:gsub("kkyo", "ｯｷｮ")
      seq = seq:gsub("kkyu", "ｯｷｭ")
      seq = seq:gsub("kkya", "ｯｷｬ")
      seq = seq:gsub("vvyo", "ｯｳﾞｮ")
      seq = seq:gsub("vvyu", "ｯｳﾞｭ")
      seq = seq:gsub("vvya", "ｯｳﾞｬ")
      seq = seq:gsub("vvo", "ｯｳﾞｫ")
      seq = seq:gsub("vve", "ｯｳﾞｪ")
      seq = seq:gsub("vvi", "ｯｳﾞｨ")
      seq = seq:gsub("vva", "ｯｳﾞｧ")
      seq = seq:gsub("rro", "ｯﾛ")
      seq = seq:gsub("rre", "ｯﾚ")
      seq = seq:gsub("rru", "ｯﾙ")
      seq = seq:gsub("rri", "ｯﾘ")
      seq = seq:gsub("rra", "ｯﾗ")
      seq = seq:gsub("ppo", "ｯﾎﾟ")
      seq = seq:gsub("ppe", "ｯﾍﾟ")
      seq = seq:gsub("ppu", "ｯﾌﾟ")
      seq = seq:gsub("ppi", "ｯﾋﾟ")
      seq = seq:gsub("ppa", "ｯﾊﾟ")
      seq = seq:gsub("bbo", "ｯﾎﾞ")
      seq = seq:gsub("bbe", "ｯﾍﾞ")
      seq = seq:gsub("bbu", "ｯﾌﾞ")
      seq = seq:gsub("bbi", "ｯﾋﾞ")
      seq = seq:gsub("bba", "ｯﾊﾞ")
      seq = seq:gsub("hho", "ｯﾎ")
      seq = seq:gsub("hhe", "ｯﾍ")
      seq = seq:gsub("ffu", "ｯﾌ")
      seq = seq:gsub("hhu", "ｯﾌ")
      seq = seq:gsub("hhi", "ｯﾋ")
      seq = seq:gsub("hha", "ｯﾊ")
      seq = seq:gsub("ddo", "ｯﾄﾞ")
      seq = seq:gsub("dde", "ｯﾃﾞ")
      seq = seq:gsub("ddu", "ｯﾂﾞ")
      seq = seq:gsub("ddi", "ｯﾁﾞ")
      seq = seq:gsub("dda", "ｯﾀﾞ")
      seq = seq:gsub("tto", "ｯﾄ")
      seq = seq:gsub("tte", "ｯﾃ")
      seq = seq:gsub("ttsu", "ｯﾂ")
      seq = seq:gsub("tchi", "ｯﾁ")
      seq = seq:gsub("tta", "ｯﾀ")
      seq = seq:gsub("zzo", "ｯｿﾞ")
      seq = seq:gsub("zze", "ｯｾﾞ")
      seq = seq:gsub("zzu", "ｯｽﾞ")
      seq = seq:gsub("jji", "ｯｼﾞ")
      seq = seq:gsub("zza", "ｯｻﾞ")
      seq = seq:gsub("sso", "ｯｿ")
      seq = seq:gsub("sse", "ｯｾ")
      seq = seq:gsub("ssu", "ｯｽ")
      seq = seq:gsub("sshi", "ｯｼ")
      seq = seq:gsub("ssa", "ｯｻ")
      seq = seq:gsub("ggo", "ｯｺﾞ")
      seq = seq:gsub("gge", "ｯｹﾞ")
      seq = seq:gsub("ggu", "ｯｸﾞ")
      seq = seq:gsub("ggi", "ｯｷﾞ")
      seq = seq:gsub("gga", "ｯｶﾞ")
      seq = seq:gsub("kko", "ｯｺ")
      seq = seq:gsub("kke", "ｯｹ")
      seq = seq:gsub("kku", "ｯｸ")
      seq = seq:gsub("kki", "ｯｷ")
      seq = seq:gsub("kka", "ｯｶ")
      seq = seq:gsub("vvu", "ｯｳﾞ")
      seq = seq:gsub("ryo", "ﾘｮ")
      seq = seq:gsub("ryu", "ﾘｭ")
      seq = seq:gsub("rya", "ﾘｬ")
      seq = seq:gsub("myo", "ﾐｮ")
      seq = seq:gsub("myu", "ﾐｭ")
      seq = seq:gsub("mya", "ﾐｬ")
      seq = seq:gsub("pyo", "ﾋﾟｮ")
      seq = seq:gsub("pyu", "ﾋﾟｭ")
      seq = seq:gsub("pya", "ﾋﾟｬ")
      seq = seq:gsub("byo", "ﾋﾞｮ")
      seq = seq:gsub("byu", "ﾋﾞｭ")
      seq = seq:gsub("bya", "ﾋﾞｬ")
      seq = seq:gsub("fyo", "ﾌｮ")
      seq = seq:gsub("fyu", "ﾌｭ")
      seq = seq:gsub("fya", "ﾌｬ")
      seq = seq:gsub("fo", "ﾌｫ")
      seq = seq:gsub("fe", "ﾌｪ")
      seq = seq:gsub("fi", "ﾌｨ")
      seq = seq:gsub("fa", "ﾌｧ")
      seq = seq:gsub("hyo", "ﾋｮ")
      seq = seq:gsub("hyu", "ﾋｭ")
      seq = seq:gsub("hya", "ﾋｬ")
      seq = seq:gsub("nyo", "ﾆｮ")
      seq = seq:gsub("nyu", "ﾆｭ")
      seq = seq:gsub("nya", "ﾆｬ")
      seq = seq:gsub("dyo", "ﾁﾞｮ")
      seq = seq:gsub("dyu", "ﾁﾞｭ")
      seq = seq:gsub("dya", "ﾁﾞｬ")
      seq = seq:gsub("dye", "ﾁﾞｪ")
      seq = seq:gsub("tso", "ﾂｫ")
      seq = seq:gsub("tse", "ﾂｪ")
      seq = seq:gsub("tsi", "ﾂｨ")
      seq = seq:gsub("tsa", "ﾂｧ")
      seq = seq:gsub("cho", "ﾁｮ")
      seq = seq:gsub("chu", "ﾁｭ")
      seq = seq:gsub("cha", "ﾁｬ")
      seq = seq:gsub("che", "ﾁｪ")
      seq = seq:gsub("jo", "ｼﾞｮ")
      seq = seq:gsub("ju", "ｼﾞｭ")
      seq = seq:gsub("ja", "ｼﾞｬ")
      seq = seq:gsub("je", "ｼﾞｪ")
      seq = seq:gsub("sho", "ｼｮ")
      seq = seq:gsub("shu", "ｼｭ")
      seq = seq:gsub("sha", "ｼｬ")
      seq = seq:gsub("she", "ｼｪ")
      seq = seq:gsub("gwo", "ｸﾞｫ")
      seq = seq:gsub("gwe", "ｸﾞｪ")
      seq = seq:gsub("gwi", "ｸﾞｨ")
      seq = seq:gsub("gwa", "ｸﾞｧ")
      seq = seq:gsub("gyo", "ｷﾞｮ")
      seq = seq:gsub("gyu", "ｷﾞｭ")
      seq = seq:gsub("gya", "ｷﾞｬ")
      seq = seq:gsub("kwo", "ｸｫ")
      seq = seq:gsub("kwe", "ｸｪ")
      seq = seq:gsub("kwi", "ｸｨ")
      seq = seq:gsub("kwa", "ｸｧ")
      seq = seq:gsub("kyo", "ｷｮ")
      seq = seq:gsub("kyu", "ｷｭ")
      seq = seq:gsub("kya", "ｷｬ")
      seq = seq:gsub("vyo", "ｳﾞｮ")
      seq = seq:gsub("vyu", "ｳﾞｭ")
      seq = seq:gsub("vya", "ｳﾞｬ")
      seq = seq:gsub("vo", "ｳﾞｫ")
      seq = seq:gsub("ve", "ｳﾞｪ")
      seq = seq:gsub("vi", "ｳﾞｨ")
      seq = seq:gsub("va", "ｳﾞｧ")
      seq = seq:gsub("who", "ｳｫ")
      seq = seq:gsub("whe", "ｳｪ")
      seq = seq:gsub("whi", "ｳｨ")
      seq = seq:gsub("wha", "ｳｧ")
      seq = seq:gsub("tsu", "ﾂ")
      seq = seq:gsub("chi", "ﾁ")
      seq = seq:gsub("shi", "ｼ")
      seq = seq:gsub("wo", "ｦ")
      seq = seq:gsub("wa", "ﾜ")
      seq = seq:gsub("ro", "ﾛ")
      seq = seq:gsub("re", "ﾚ")
      seq = seq:gsub("ru", "ﾙ")
      seq = seq:gsub("ri", "ﾘ")
      seq = seq:gsub("ra", "ﾗ")
      seq = seq:gsub("yo", "ﾖ")
      seq = seq:gsub("yu", "ﾕ")
      seq = seq:gsub("ya", "ﾔ")
      seq = seq:gsub("mo", "ﾓ")
      seq = seq:gsub("me", "ﾒ")
      seq = seq:gsub("mu", "ﾑ")
      seq = seq:gsub("mi", "ﾐ")
      seq = seq:gsub("ma", "ﾏ")
      seq = seq:gsub("po", "ﾎﾟ")
      seq = seq:gsub("pe", "ﾍﾟ")
      seq = seq:gsub("pu", "ﾌﾟ")
      seq = seq:gsub("pi", "ﾋﾟ")
      seq = seq:gsub("pa", "ﾊﾟ")
      seq = seq:gsub("bo", "ﾎﾞ")
      seq = seq:gsub("be", "ﾍﾞ")
      seq = seq:gsub("bu", "ﾌﾞ")
      seq = seq:gsub("bi", "ﾋﾞ")
      seq = seq:gsub("ba", "ﾊﾞ")
      seq = seq:gsub("ho", "ﾎ")
      seq = seq:gsub("he", "ﾍ")
      seq = seq:gsub("fu", "ﾌ")
      seq = seq:gsub("hu", "ﾌ")
      seq = seq:gsub("hi", "ﾋ")
      seq = seq:gsub("ha", "ﾊ")
      seq = seq:gsub("nn", "ﾝ")
      seq = seq:gsub("no", "ﾉ")
      seq = seq:gsub("ne", "ﾈ")
      seq = seq:gsub("nu", "ﾇ")
      seq = seq:gsub("ni", "ﾆ")
      seq = seq:gsub("na", "ﾅ")
      seq = seq:gsub("do", "ﾄﾞ")
      seq = seq:gsub("de", "ﾃﾞ")
      seq = seq:gsub("du", "ﾂﾞ")
      seq = seq:gsub("di", "ﾁﾞ")
      seq = seq:gsub("da", "ﾀﾞ")
      seq = seq:gsub("to", "ﾄ")
      seq = seq:gsub("te", "ﾃ")
      seq = seq:gsub("ta", "ﾀ")
      seq = seq:gsub("zo", "ｿﾞ")
      seq = seq:gsub("ze", "ｾﾞ")
      seq = seq:gsub("zu", "ｽﾞ")
      seq = seq:gsub("ji", "ｼﾞ")
      seq = seq:gsub("za", "ｻﾞ")
      seq = seq:gsub("so", "ｿ")
      seq = seq:gsub("se", "ｾ")
      seq = seq:gsub("su", "ｽ")
      seq = seq:gsub("sa", "ｻ")
      seq = seq:gsub("go", "ｺﾞ")
      seq = seq:gsub("ge", "ｹﾞ")
      seq = seq:gsub("gu", "ｸﾞ")
      seq = seq:gsub("gi", "ｷﾞ")
      seq = seq:gsub("ga", "ｶﾞ")
      seq = seq:gsub("ko", "ｺ")
      seq = seq:gsub("ke", "ｹ")
      seq = seq:gsub("ku", "ｸ")
      seq = seq:gsub("ki", "ｷ")
      seq = seq:gsub("ka", "ｶ")
      seq = seq:gsub("vu", "ｳﾞ")
      seq = seq:gsub("o", "ｵ")
      seq = seq:gsub("e", "ｴ")
      seq = seq:gsub("u", "ｳ")
      seq = seq:gsub("i", "ｲ")
      seq = seq:gsub("a", "ｱ")
      yield(Candidate("katakana_halfwidth", seg.start, seg._end, seq, " ｶﾀｶﾅ"))
   end
end

return katakana_halfwidth
